# TCP协议从链接可靠性方面认识到最基本的三次握手，四次挥手，再换个角度从传输速率方面看，他都有那些特性呢？
> 之前只是有个模糊的印象，知道有个tcp慢启动，滑动窗口这些，现在决定再认真学习下里面的东西。

## 滑动窗口
- 最开始tcp是采用发送等待的过程。
> 发送方发送了数据后启动一个定时器，如果这段时间内没有收到确认包，就认为数据丢失需要重传。这种方式其实有个很明显的缺点就是你发一个包就要给个确认，
整体效率不好。

- 采用滑动窗口的形式。
> 滑动窗口实际上有接受窗口和发送窗口两个，接收方需要告诉发送方自己的窗口大小，从而动态的控制发送速率，如果网络质量良好，接收方处理也很快，那么可
以通知发送方下一次可以发送多些数据，相反如果接收方处理速度有限或者网络质量不好，那么发送方也要调小发送窗口。
 - 这里有个公式，如果窗口大小是m，ack确认号是n，发送方已发送了x字节，那么可以算出来下一次要发送的字节就是m-x-n
 - 站在发送方角度发送缓存分为，已经发送并收到ack的，已经发送未收到ack的，未发送但是允许发送的，未发送不允许发送的，**已经发送未收到ack的，但是
 允许发送的**称为发送窗口。
 - 站在接收方的角度接收缓存分为，已接收，未接收准备接收，未接收不准备接收的，其中**未接收准备接收**的称为发送窗口。
 - 滑动窗口的重点在于：发送方窗口需要通过接收方的ack来确定大小，接收方窗口大小则取决于自身硬件，应用的处理能力。
 - 零窗口问题：主要是接收方缓冲区已经占满，但是应用还没有处理这些数据，所以导致缓冲区没有更多空间区接收其他包，所以这个时候发送方也会停止发包。
 
## TCP慢启动
- 慢启动主要是探测网络环境变化做的一种措施
> 当tcp刚开始建立起链接的时候会发送大量的包可能会导致占满链路中路由器缓存导致网络拥塞。这里的名字叫做慢启动，其实不仅仅是在建立链接的过程中才会
采用这种算法，当tcp判断到网络拥塞后（判断条件：当出现超时重传时，表明网络质量不好）会触发慢启动。
- 慢启动的过程：
    - 发送窗口大小初始化为1
    - 接收到一个ack报文后加1，这个时候可以发送两个报文段，发送窗口也会变成4，随着这个过程的进行发送窗口会指数级的增长。
    - 发送窗口最大增长到65536字节（tcp报文格式中窗口大小为16bit，所以是2的16次方）
- 网络拥塞避免过程：
    - 调整发送窗最大大小为滑动窗口一半大小
    - 设置滑动窗口大小为1
    - 重新进入慢启动过程
    
## 快速重传
> 快速重传主要是应对包丢失的问题（主要可能是checksum，其他的网络拥塞其实使用网络用塞的方式处理，但是如果checksum包失败，其实这种情况很少发生，
直接网速减半很不科学）触发条件是出现大于等于3次相同ack（为什么是3次呢，因为两次的情况肯定是数据包乱序导致不需要重传，tcp自己会进行重新排序，
在没丢包的情况下出现三次ack的概率是百分之40%）
- 快速重传过程(整个过程不需要等待超时)：
    - 调整发送窗最大阀值为滑动窗口一半大小
    - 设置滑动窗口大小为发送窗最大大小
    - 重新进入拥塞避免过程
    
## 快速恢复
> 快速恢复的主要思想是网络包守恒，当老的数据包离开后才能再去发送新的包
- 快速恢复过程（收到三个重复ack后）：
    - 调整发送窗最大阀值为滑动窗口一半
    - 设置滑动窗口大小为发送窗阀值加三（收到3个包，说明3个包离开网络）
    - 再说到重复ack，发送窗口加一
    - 收到新的数据包后，发送窗口设置为第一步的最大阀值。
    - 重新进入拥塞避免过程

---

- 参考阅读：
    - <https://hulinhong.com/2017/09/23/%E7%99%BD%E8%AF%9Dtcp%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0/>
    - <https://blog.csdn.net/itmacar/article/details/12278769>